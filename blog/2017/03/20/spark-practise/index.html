<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Spark 入门实操 - enzo&#39;s note book</title>
    <meta charset="utf-8" />
    <meta name="author" content="enzo liu" />
    <meta name="description" content="spark" />
    <meta name="keywords" content="spark" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
    <link rel="stylesheet" href="/media/css/prettify.css" type="text/css">
  </head>
  <body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">enzo&#39;s note book</a></h1>
        <p>M-x (sketch for random ideas)</p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/history/">History</a></li>
          <li><a href="/leetcode/">Leetcode</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="https://github.com/Enzo-Liu">GitHub</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="//www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="blog.enzo.cc">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1>Spark 入门实操</h1>

<div id="outline-container-org5d418ce" class="outline-2">
<h2 id="org5d418ce">背景</h2>
<div class="outline-text-2" id="text-org5d418ce">
<p>
内网服务器的 spark 又跑不动了... 所以在阿里云上买两台机器, 严肃点的部署一下.
顺便把之前的 pyspark 脚本也迁移到 scala 上，可以利用起我们 java 下的资源.
</p>
</div>
</div>

<div id="outline-container-orgfe083b5" class="outline-2">
<h2 id="orgfe083b5">部署环境</h2>
<div class="outline-text-2" id="text-orgfe083b5">
<ul class="org-ul">
<li>机器阿里云 2 台 4 核 16g</li>
<li>依赖软件
<ul class="org-ul">
<li>ansible-2.0</li>
<li>spark-2.1</li>
<li>jdk-1.8</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org17b2e6d" class="outline-2">
<h2 id="org17b2e6d">部署过程</h2>
<div class="outline-text-2" id="text-org17b2e6d">
<blockquote>
<p>
为了后续添加 slave 方便，在 ansible 的脚本上花了很大的功夫。根据 master 以及 slave 的 inventory 配置
</p>
<ul class="org-ul">
<li>自动配置 authorized_keys</li>
<li>自动配置 master 的 ssh_config</li>
<li>自动 配置 nfs, 以及 mount master 的工作区目录</li>
</ul>
</blockquote>

<p>
具体 ansible 脚本的执行步骤大致如下:
</p>
<ul class="org-ul">
<li>安装 jdk</li>
<li>安装 spark</li>
<li>生成以及拷贝 spark 的配置文件
<dl class="org-dl">
<dt>conf/slaves</dt><dd>配置 各个 slave 的 ssh 的别名</dd>
<dt>conf/spark-defaults.conf</dt><dd>配置 master 的 url</dd>
<dt>conf/spark-env.sh</dt><dd>配置 JAVA_HOME, SPARK_HOME, 各类 MEMORY</dd>
</dl></li>
<li>配置 master 的 ssh_key, 以及添加到 slave 的 authorized_keys 中
<ul class="org-ul">
<li>spark 的 start-all.sh 中通过 ssh 来启动所有的 slave 的 worker</li>
</ul></li>
<li>配置 nfs 共享工作区
<ul class="org-ul">
<li>运行模式下需要所有的 worker 都能根据地址访问到所要执行的 jar</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org0d78c6b" class="outline-2">
<h2 id="org0d78c6b">发布方式</h2>
<div class="outline-text-2" id="text-org0d78c6b">
<ul class="org-ul">
<li>打包
<code>sbt assembly</code></li>
<li>上传
<code>scp $WORKING_DIR/target/*.jar spark:/home/spark/workspace/</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgd7921b4" class="outline-2">
<h2 id="orgd7921b4">执行方式</h2>
<div class="outline-text-2" id="text-orgd7921b4">
<p>
<code>crontab</code> 定期调度
</p>
<div class="org-src-container">
<pre class="src src-shell">$SPARK_HOME/bin/spark-submit --class *** /home/spark/workspace/***
</pre>
</div>
</div>
</div>

<div id="outline-container-org8278c70" class="outline-2">
<h2 id="org8278c70">App 示例</h2>
<div class="outline-text-2" id="text-org8278c70">
<div class="org-src-container">
<pre class="src src-scala">val idsRDD = odpsOps.readTable(project, table, pr, read, numPartitions)
  .filter(_.time.isAfter(start)) // 保留最近一个月的访问记录
  .map(r =&gt; ((r.dvid, r.time), r.id)) //转换成设备号，访问日期，ID 的格式
  .groupBy(_._1).map(_._2.map(_._2)).map(_.toSet) //根据设备号和访问日期聚合，且仅保留 ID 的信息

val weightRdd = generate(idsRDD)

def listToPair[T](ls:List[T]):List[(T,T)] = ls match {
  case Nil =&gt; List()
  case a::ls =&gt; ls.map((a,_)) ++ listToPair(ls)
}

def sort(p:(Int,Int)) : (Int,Int) = if (p._1 &lt; p._2) p else p.swap

def toScore(elementNums:Map[Int,Long], pairNums:((Int,Int),Int)) : ((Int,Int), Double) = {
  val ((a,b),n) = pairNums
  ((a,b), n / Math.sqrt(1.0*elementNums(a)*elementNums(b)))
}

def generate(ls:RDD[Set[Int]]) : RDD[((Int,Int),Double)] = {
  val flattened = ls.flatMap(s=&gt;listToPair(s.toList))
  val elementNumbers = ls.flatMap(_.toList).countByValue()
  flattened.groupBy(sort).mapValues(_.size)
    .map(r=&gt;toScore(elementNumbers,r))
    .flatMap(withReverse)
}

def withReverse(res: ((Int,Int), Double)) = {
  val ((activityId, relatedId), weight) = res
  Seq(res, ((relatedId, activityId),weight))
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org0574d80" class="outline-2">
<h2 id="org0574d80">执行结果</h2>
<div class="outline-text-2" id="text-org0574d80">
<p>
同样的功能，由于
</p>
<ul class="org-ul">
<li>数据源切换到了阿里云的 odps(内网带宽千兆可以跑满)</li>
<li>减少了 nginx 日志的解析工作(odps 里可以相对结构化的存储信息)</li>
</ul>
<p>
原本 2 小时的执行任务，现在 4 分钟就能搞定...
</p>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2017-03-20</span>
        <span title="last modification date" class="post-info">2017-03-21</span>
        <span title="tags" class="post-info"><a href="/tags/spark/">spark</a></span>
        <span title="author" class="post-info">enzo liu</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/2017/03/20/spark-practise";
          var disqus_url = "https://blog.enzo.cc/blog/2017/03/20/spark-practise";
          var disqus_shortname = 'enzo-liu';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="//disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </section>
      <script src="//code.jquery.com/jquery-latest.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:liuenze6516 &lt;at&gt; gmail &lt;dot&gt; com">enzo liu</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
